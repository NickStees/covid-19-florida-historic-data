<template>
  <div class="content container">
    <div id="app">
      <div v-if="refreshModal" class="modal refresh-modal">
        <!-- Modal content -->
        <div class="modal-content">
          <p><i class="fa fa-refresh fa-spin fa-3x fa-fw"></i><br>Updating With Latest Data...</p>
        </div>
      </div>
      <div class="">
        <div class="text-center">
          <h1 class="text-white text-center">Florida Coronavirus (COVID-19) Tracker</h1>
        </div>
        <div class="solid-bk">
        <div class="text-center">
            <div style="line-height:1.5;">Daily numbers from the <a
              href="https://fdoh.maps.arcgis.com/apps/opsdashboard/index.html#/8d0de33f260d444c852a615dc7837c86"
            >Florida Department of Health</a> tracking the Coronavirus progress.
            <div class=""><small>State data is updated after approximately 11 a.m. daily.</small>
            </div>
          </div>
          <div v-if="installBtn" class="btn btn-success p-2 m-1" @click="installer()"><i class="fa fa-download"></i> Install for Latest Updates</div>
        </div>
          <div v-if="latestStateValue" class="row flex-column flex-sm-row padded align-middle align-items-center">
            <div class="col">
              <div class="row">
                <div class="col-4 text-right-desktop"><h2 class="h4">Florida Cases</h2></div>
                <div class="col-8 text-left">
                  <div class="badge fa-2x"> <countTo :endVal='latestStateValue' :duration='2200'></countTo></div>
                  <span class="p-2" v-if="parseInt(stateCasesIncrease[stateCasesIncrease.length - 1]) === 0" v-html="stateCasesIncrease[stateCasesIncrease.length - 2]"></span><span class="p-2" v-else v-html="stateCasesIncrease[stateCasesIncrease.length - 1]"></span>
                  <div class="badge" style="background-color:black;">
                  <span class="fa-2x"> <countTo :endVal='latestDeaths' :duration='1200'></countTo></span> Deaths
                  </div>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="row flex-column flex-sm-row">
                <div class="col text-right-desktop">
                  <h3 class="h5">Projected Cases</h3>
                </div>
                <div class="col  text-right-desktop">
                  <strong class="badge background-secondary fa-1x"><countTo :endVal='compoundInterest(latestStateValue, stateAvg, 3)' :duration='3000'></countTo></strong> in 3 days
                </div>
                <div class="col">
                  <strong class="badge background-secondary fa-1x"><countTo :endVal='compoundInterest(latestStateValue, stateAvg, 7)' :duration='3500'></countTo></strong> in 7 days
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>


      <div class="row padded" v-if="messages.length">
        <div class="alert alert-danger" v-for="message in messages">
          {{message}}
        </div>
      </div>


      <div>
        <div class="row padded">
          <div class="col-md-6 col-lg-7">
            <div class="text-center background-primary">
              <strong class="text-white">Top Coronavirus Cases by Florida County</strong>
            </div>
            <div class="rank-list solid-bk">
              <div v-if="flCountiesLoading" class="text-center">
                <i class="fa fa-refresh fa-spin fa-3x fa-fw"></i>
                <span class="sr-only">Loading...</span>
              </div>
              <div v-else>
                <div v-if="flCounties && flCounties.length">
                  <div
                    class="item"
                    v-for="county in flCounties"
                    :class="{ active: currentCounty ? county.attributes.COUNTYNAME == currentCounty.attributes.COUNTYNAME : false }"
                    @click="plotData(county.attributes.COUNTYNAME)"
                    :key="county.attributes.COUNTYNAME"
                  >
                    <div class="col-name text-right">
                      <span class="countyname">{{ county.attributes.County_1 }}</span> -
                    </div>
                    <div class="col-cnt flex flex-row">
                      <span class="count">{{ county.attributes.TPositive | toLocal }}</span>
                      <span
                        class="ranking background-primary"
                        :style="{ width: (county.attributes.TPositive / casesSummary.max) * 100 + '%' }"
                      ></span>
                    </div>
                    <div class="col-capital text-center" v-if="countyInfo[county.attributes.COUNTYNAME] && countyInfo[county.attributes.COUNTYNAME].pop">
                      <span class="badge fa-1x"><i class="fa fa-university small" aria-hidden="true"></i> {{((county.attributes.TPositive / countyInfo[county.attributes.COUNTYNAME].pop) * 100000).toFixed(0)}}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6 col-lg-5">
            <div v-if="currentCounty && currentCounty.attributes" class="border-primary">
              <div class="background-primary  text-center"><strong>{{currentCounty.attributes.County_1}} County Cases</strong></div>
              <ul class="list-group">
                <li class="list-group-item">
                  <div class="row">
                    <div class="col-6 text-right-desktop">
                      <div class="badge fa-3x" >
                        <strong><countTo :endVal='currentCounty.attributes.TPositive' :duration='1200'></countTo></strong>
                      </div>
                    </div>
                    <div class="col-6">
                      <strong>{{currentCounty.attributes.County_1}} County<br> Positive Cases <span v-if="parseInt(selectedCountyCasesIncrease[selectedCountyCasesIncrease.length - 1]) === 0" v-html="selectedCountyCasesIncrease[selectedCountyCasesIncrease.length - 2]"></span><span v-else v-html="selectedCountyCasesIncrease[selectedCountyCasesIncrease.length - 1]"></span></strong>
                    </div>
                  </div>
                </li>
                <li class="list-group-item">
                  <strong>Projected Cases</strong> if {{selectedCountyAvg.toFixed(0)}}% avg. trend continues
                  <div class="row">
                    <div class="col-6 col-sm-6  text-right-desktop"><strong class="badge background-secondary fa-1x">{{compoundInterest(currentCounty.attributes.TPositive, selectedCountyAvg, 3) | toLocal }}</strong> in 3 days</div>
                    <div class="col-6 col-sm-6"><strong class="badge background-secondary fa-1x">{{compoundInterest(currentCounty.attributes.TPositive, selectedCountyAvg, 7) | toLocal }}</strong> in 7 days</div>
                  </div>

                </li>
                <li class="list-group-item">
                  <div class="row">
                    <div class="col-6 text-right-desktop">
                      <div class="badge fa-2x"><i class="fa fa-university small" aria-hidden="true"></i> {{((currentCounty.attributes.TPositive / countyInfo[currentCounty.attributes.COUNTYNAME].pop) * 100000).toFixed(0)}}</div>
                    </div>
                    <div class="col-6">
                      <strong>Cases per Capita</strong><br><small>{{((currentCounty.attributes.TPositive / countyInfo[currentCounty.attributes.COUNTYNAME].pop) * 100000).toFixed(0)}} out of 100k people</small>
                    </div>
                  </div>
                </li>
                <li class="list-group-item">
                  <div class="row">
                    <div class="col-6 text-right-desktop">
                      <div class="fa-2x">
                        {{(currentCounty.attributes.TPositive / currentCounty.attributes.T_total) | toPercent }}<sup>%</sup>
                      </div>
                    </div>
                    <div class="col-6">
                      <strong>Tested are positive <br> for COVID-19</strong>
                    </div>
                  </div>
                </li>
                <li class="list-group-item">
                  <div class="row">
                    <div class="col-6 text-right-desktop" v-if="currentCounty.attributes.C_FLResDeaths">
                      <div class="badge fa-2x" style="background-color:black;">
                        {{currentCounty.attributes.C_FLResDeaths | toLocal }}
                      </div>
                    </div>
                    <div class="col-6">
                      <div class="d-flex" style="align-items:center;">
                        <strong>Deaths</strong>
                      </div>
                    </div>
                  </div>
                </li>
                <li class="list-group-item">
                  <div class="row">
                    <div class="col-6 text-right-desktop">
                      <div >
                        <strong><countTo :endVal='currentCounty.attributes.T_total' :duration='1200'></countTo></strong>
                      </div>
                    </div>
                    <div class="col-6">
                      <div class="d-flex" style="align-items:center;">
                        <strong>Total Tested</strong>
                      </div>
                    </div>
                  </div>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <hr />

      <div class="row padded">
        <div class="col-md-12">
          <div class="solid-bk text-center">
            <strong style="color: #fb7dd4">NEW</strong> <span style="border-bottom: dashed #fb7dd4 4px">Active Positive Cases</span> - The sum of newly reported cases in the past {{daysForActiveCases}} days. Assuming the individual is no longer infected after {{daysForActiveCases}} days, this is the best method to estimate active corona virus cases in the region.
          </div>
          </div>
      </div>

      <div class="row">
        <div class="col-md-6">
          <div class="solid-bk">
          <div class="header">
            <div
              class="chartjs-title"
              v-if="currentCounty.attributes"
            >{{currentCounty.attributes.County_1}} County Active Cases and Testing</div>
          </div>
          <line-chart chart-id="county-testing-chart" :chart-data="lineTestingData" :options="lineTestingOptions" :height="330" :width="400"></line-chart>
          </div>
                    <hr>
                    <div class="solid-bk">
          <div class="header">           <div
              class="chartjs-title"
              v-if="currentCounty.attributes"
            >{{currentCounty.attributes.County_1}} County Cases</div>
          </div>
          <line-chart chart-id="county-chart" :chart-data="lineData" :options="lineOptions" :height="330" :width="400"></line-chart>
          <div class="percentChange">
            <div>Latest Daily Changes</div>
            <div v-for="percent in selectedCountyCasesIncrease.slice(selectedCountyCasesIncrease.length -5)" v-html="percent"></div>
          </div>
          </div>
          <hr>

          <div class="solid-bk">
          <div class="header">
            <div
              class="chartjs-title"
              v-if="currentCounty.attributes"
            >{{currentCounty.attributes.County_1}} County Deaths</div>
          </div>
          <line-chart chart-id="county-chart2" :chart-data="barData2" :options="barOptions2" :height="330" :width="400"></line-chart>
          </div>
        </div>
        <div class="col-md-6 state-col">
 <div class="solid-bk">
          <div class="header">
            <div class="chartjs-title">Florida State Active Cases and Testing</div>
          </div>
          <line-chart chart-id="state-testing-chart" :chart-data="stateLineTestingData" :options="stateLineTestingOptions" :height="330" :width="400"></line-chart>
           </div>
                     <hr>          <div class="solid-bk">
          <div class="header">
            <div class="chartjs-title">Florida State Cases</div>
          </div>
          <line-chart chart-id="state-chart" :chart-data="stateLineData" :options="stateLineOptions" :height="330" :width="400"></line-chart>
          <div class="percentChange">
            <div>Latest Daily Changes</div>
            <div v-for="percent in stateCasesIncrease.slice(stateCasesIncrease.length -5)" v-html="percent"></div>
          </div>
           </div>
          <hr>

          <div class="solid-bk">
          <div class="header">
            <div
              class="chartjs-title"
            >Florida State Deaths</div>
          </div>
          <line-chart chart-id="state-chart2" :chart-data="stateBarDataDeaths" :options="barOptions2" :height="330" :width="400"></line-chart>
          </div>
        </div>
      </div>

      <hr />

      <footer class="mt-5 py-4 text-center border-top">
        <div class="container">
          <div class="row">
            <div class="col-12"><p>Created by <a href="https://www.nicholasstees.com/" rel="noopener nofollow" target="_blank">Nicholas Stees</a> a web developer in Tampa Florida</p></div>
          </div>
        </div>
      </footer>

    </div>
  </div>
</template>

<script>
// import HelloWorld from './components/HelloWorld.vue'
import _remove from '../node_modules/lodash/remove'
// import _sortBy from '../node_modules/lodash/sortBy'
import _filter from "../node_modules/lodash/filter";
import countTo from 'vue-count-to';
import axios from "axios";
import LineChart from "./components/LineChart.js";
import BarChart from "./components/BarChart.js";
let ROOT_PATH = 'https://flacoronavirustracker.com/'

// axios.defaults.timeout = 10000;

export default {
  name: "App",
  components: { countTo, LineChart, BarChart },
  data: function() {
    return {
      logo: ROOT_PATH + require('./assets/logo.png'),
      refreshModal: false,
      messages: [],
      installBtn: false,
      daysBackToFetch: 45,
      daysBackToDisplay: 30,
      daysForActiveCases: 14,
      installer: undefined,
      flCounties: [],
      flCountiesLoading: true,
      alldata: [],
      selectedCounty: {},
      selectedCountyAvg: 0,
      selectedCountyCases: [],
      selectedCountyCasesIncrease: [],
      selectedCountyIncreaseByDay: [],
      selectedCountyIncreaseDeathsByDay: [],
      selectedStateIncreaseByDay: [],
      selectedStateIncreaseDeathsByDay: [],
      stateCases: [],
      latestDeaths: null,
      stateCasesIncrease: [],
      stateAvg: 0,
      latestStateValue: 0,
      countyInfo: null,
      lineOptions: {
          scales: {
             xAxes: [{
               gridLines: {
                  color: 'rgba(255,255,255,.15)'
                },
             }],
            yAxes: [
              {
                // color: red,
                ticks: {
                  suggestedMin: 0,
                  precision: 0
                },
                // gridLines: {
                //   color: 'rgba(255,255,255,.15)'
                // },
              }
            ],
          },
          legend: {
            position: 'top',
            labels: {
              fontColor: 'rgba(255,255,255,.75)'
            }
          },

        },
      barData2: {},
      stateBarDataDeaths: {},
      barOptions2: {
          scales: {
              xAxes: [{
                  stacked: true,
                  gridLines: {
                  color: 'rgba(255,255,255,.15)'
                },
              }],
              yAxes: [{
                  stacked: true,
                  ticks: {
                  suggestedMin: 0,
                  precision: 0
                }
              }]
          },
          legend: {
            position: 'top',
            labels: {
              fontColor: 'rgba(255,255,255,.75)'
            }
          },

        },
      lineData: {},
      lineTestingOptions: {
          scales: {
            xAxes: [{
              stacked: true,
               gridLines: {
                  color: 'rgba(255,255,255,.15)'
                },
             }],
             yAxes: [
              {
                stacked: true,
                ticks: {
                  suggestedMin: 0,
                  precision: 0
                }
              }
            ]
          },
          legend: {
            position: 'top',
            labels: {
              fontColor: 'rgba(255,255,255,.75)'
            }
          },
        },
      lineTestingData: {},
      stateLineOptions:{
          scales: {
            xAxes: [{
               gridLines: {
                  color: 'rgba(255,255,255,.15)'
                },
             }],
             yAxes: [
              {
                ticks: {
                  suggestedMin: 0,
                  precision: 0
                }
              }
            ]
          },
          legend: {
            position: 'top',
            labels: {
              fontColor: 'rgba(255,255,255,.75)'
            }
          },
        },
      stateLineData:{},
      stateLineTestingOptions:{
          scales: {
            xAxes: [{
              stacked: true,
               gridLines: {
                  color: 'rgba(255,255,255,.15)'
                },
             }],
             yAxes: [
              {
                stacked: true,
                ticks: {
                  suggestedMin: 0,
                  precision: 0
                }
              }
            ]
          },
          legend: {
            position: 'top',
            labels: {
              fontColor: 'rgba(255,255,255,.75)'
            }
          },
        },
      stateLineTestingData:{},
    };
  },
  created (){
    let installPrompt;
    var self = this;

    window.addEventListener("beforeinstallprompt" , e => {
      e.preventDefault();
      installPrompt = e;
      this.installBtn = true;
    })

    document.addEventListener('swUpdated', self.updateAvailable, { once: true })

    this.installer = () => {
      this.installBtn = 'none';
      installPrompt.prompt();
      installPrompt.userChoice.then(result =>{
        if (result.outcome === 'accepted'){
          console.log('user accepted')
          self.$ga.event('pwa', 'accepted', 'yes')
        }else{
          console.log("user denied")
          self.$ga.event('pwa', 'denied', 'no')
        }
        installPrompt = null;
      })
    }

  },
  async mounted() {
    // get info
    var self = this;
    var hour = new Date().getHours();
    try {
      var results = [];
      var stateResults = [];
      let today = new Date();
      let todayMonth = ("0" + (today.getMonth() + 1)).slice(-2); //month with leading 0
      let todayDay = today.getDate();
      // start requests
      let counties = await axios.get(
        "https://services1.arcgis.com/CY1LXxl9zlJeBuRZ/arcgis/rest/services/Florida_COVID19_Cases/FeatureServer/0/query?f=json&where=1%3D1&returnGeometry=false&spatialRel=esriSpatialRelIntersects&outFields=*&orderByFields=TPositive%20desc&outSR=102100&resultOffset=0&resultRecordCount=67&cacheHint=true"
      );
      let fetchedData = await axios.get("/assets/data.txt");
      fetchedData.data
        .split("\n")
        .filter(d => d)
        .splice(self.daysBackToFetch * -1)
        .forEach(async day => {
          try {
          let response = await axios.get(`/assets/data/${day}.json`);
          day = day.replace("tampa-", "").trim();
          results.push({
            date: day,
            mmdd: day.substring(4, 6) + "/" + day.slice(-2),
            data: response.data
          });
          } catch (err) {
            console.log(err);
            self.$ga.event('error', 'fetchedData', err)
          }
        });
      // get now data
      if (hour >= 11) {
        let nowData = await axios.get(
          "https://services1.arcgis.com/CY1LXxl9zlJeBuRZ/arcgis/rest/services/Florida_COVID19_Cases/FeatureServer/0/query?f=json&where=T_positive%20IS%20NOT%20NULL&returnGeometry=false&spatialRel=esriSpatialRelIntersects&outFields=*&orderByFields=T_positive%20desc&outSR=102100&resultOffset=0&resultRecordCount=67&cacheHint=true"
        );
        try {
          if(!nowData.data.error){
            results.push({
              date: `${today.getFullYear()}${todayMonth}${todayDay}9`,
              mmdd: `now`,
              data: nowData.data
            });
          }
        } catch (err) {
          console.log(err);
          self.$ga.event('error', 'nowData', err)
          self.messages.push('Latest Data Issue: ' + err);
        }
      }

      // State data
      let fetchedStateData = await axios.get("assets/state-data.txt");
      fetchedStateData.data
        .split("\n")
        .filter(d => d)
        .splice(self.daysBackToFetch * -1)
        .forEach(async day => {
          try {
          let response = await axios.get(`/assets/data/${day}.json`);
          day = day.replace("state-", "").trim();
          try {
            if(!response.data.error){
              stateResults.push({
                date: day,
                mmdd: day.substring(4, 6) + "/" + day.slice(-2),
                data: response.data
              });
            }
          } catch (err) {
            console.log(err);
            self.$ga.event('error', 'stateResults', err)
            self.messages.push(err);
          }
          } catch (err) {
            console.log(err);
            self.$ga.event('error', 'fetchedStateData', err)
            self.messages.push(err);
          }
        });
        console.log(hour)
        if (hour >= 11) {
          // Now state data
          let fetchedNowStateData = await axios.get(
            "https://services1.arcgis.com/CY1LXxl9zlJeBuRZ/arcgis/rest/services/Florida_COVID19_Cases/FeatureServer/0/query?f=json&where=1%3D1&returnGeometry=false&spatialRel=esriSpatialRelIntersects&outFields=*&outStatistics=%5B%7B%22statisticType%22%3A%22sum%22%2C%22onStatisticField%22%3A%22C_FLResDeaths%22%2C%22outStatisticFieldName%22%3A%22Deaths%22%7D%2C%7B%22statisticType%22%3A%22sum%22%2C%22onStatisticField%22%3A%22T_positive%22%2C%22outStatisticFieldName%22%3A%22Positive%22%7D%2C%7B%22statisticType%22%3A%22sum%22%2C%22onStatisticField%22%3A%22C_HospYes_Res%22%2C%22outStatisticFieldName%22%3A%22Hospitalized%22%7D%2C%7B%22statisticType%22%3A%22sum%22%2C%22onStatisticField%22%3A%22T_total%22%2C%22outStatisticFieldName%22%3A%22TotalTests%22%7D%2C%7B%22statisticType%22%3A%22sum%22%2C%22onStatisticField%22%3A%22T_negative%22%2C%22outStatisticFieldName%22%3A%22Negative%22%7D%2C%7B%22statisticType%22%3A%22sum%22%2C%22onStatisticField%22%3A%22TPending%22%2C%22outStatisticFieldName%22%3A%22Pending%22%7D%5D&outSR=102100&cacheHint=true"
          );
          try {
            if(!fetchedNowStateData.data.error){
              stateResults.push({
                date: `9${today.getFullYear()}${todayMonth}${todayDay}`,
                mmdd: `now`,
                data: fetchedNowStateData.data
              });
            }
          } catch (err) {
            console.log(err);
            self.$ga.event('error', 'fetchedNowStateData', err)
            self.messages.push(err);
          }
        }
      let countyInfo = await axios.get('/assets/data/county-info.json');
      self.countyInfo = countyInfo.data;
      self.alldata = results; //all done fetching data
      // remove unkown county
      _remove(counties.data.features, {
        attributes: {
          COUNTY: "999"
        }
      });
      self.flCounties = counties.data.features;
      self.flCountiesLoading = false;
      setTimeout(function(){
        let county = self.$route.params.county ? self.$route.params.county.toUpperCase() : "HILLSBOROUGH";
        self.plotData(county); // plot default
        self.plotDataState(stateResults);
      }, 300);
    } catch (err) {
      console.log(err);
      self.$ga.event('error', 'mounted', err)
      self.messages.push(err);
    }
  },
  filters: {
    toLocal: function(value) {
      return !isNaN(value) ? value.toLocaleString() : 0;
    },
    toPercent: function(value) {
      return !isNaN(value) ? (value * 100).toFixed(1) : 0;
    }
  },
  computed: {
    hillsborough: function hillsborough() {
      var matches = _filter(this.flCounties, {
        attributes: {
          COUNTYNAME: "HILLSBOROUGH"
        }
      });
      return matches[0];
    },
    casesSummary: function casesSummary() {
      return {
        min: this.flCounties[this.flCounties.length - 1].attributes.TPositive,
        max: this.flCounties[0].attributes.TPositive
      };
    },
    currentCounty: function currentCounty() {
      if(this.selectedCounty && this.selectedCounty.attributes){
        return this.selectedCounty;
      }else{
        return false;
      }
    }
  },
  methods: {
    updateAvailable(event) {
      // this.registration = event.detail
      this.refreshModal = true
      setTimeout(function() { window.location.reload(true) }, 1000);
    },
    track() {
      this.$ga.page("/");
    },
    getData: async function getData() {
      var self = this;
      try {
      } catch (err) {
        console.log(err);
        self.$ga.event('error', 'getData', err)
        self.messages.push(err);
      }
    },
    plotData: function plotData(county) {
      var self = this;
      self.$router.push('/'+county.toUpperCase()).catch(err => {console.log(err);})

      const results = self.alldata.sort((a, b) => a.date - b.date);
      let labels = results.map(x => x.mmdd);
      let labelsOriginal = [...labels];
      const thisCountyData = results.map(x => {
        var countyResults = _filter(x.data.features, {
          attributes: {
            COUNTYNAME: county.toUpperCase()
          }
        });
        return countyResults ? countyResults[0] : null;
      });
      // most recent results move to selected county
      let selectedCountyRecent = thisCountyData[thisCountyData.length - 1];
      if(!selectedCountyRecent.attributes) {
        self.$router.push("HILLSBOROUGH").catch(err => {console.log(err)})
        self.$ga.event('error', 'selectedCountyRecent', err)
        self.messages.push(err);
        return null
          }
      self.selectedCounty = selectedCountyRecent;
      var gradient = document.getElementById("county-chart").getContext("2d").createLinearGradient(0, 0, 0, 450);
      gradient.addColorStop(0, "rgba(255, 0,0, 0.9)");
      gradient.addColorStop(0.5, "rgba(255, 0, 0, 0.65)");
      gradient.addColorStop(1, "rgba(255, 0, 0, 0)");
      let gradientBlack = document.getElementById("county-chart2").getContext("2d").createLinearGradient(0, 0, 0, 450);
      gradientBlack.addColorStop(0, "rgba(0, 0, 0, 0.75)");
      gradientBlack.addColorStop(0.5, "rgba(0, 0, 0, 0.55)");
      gradientBlack.addColorStop(1, "rgba(0, 0, 0, .2)");
      var projectedData = [];
      let countyData = self.getCountyAttributeValue(results, county, 'T_positive')
      self.selectedCountyCases = countyData;
      let justPercentNumbers = [];
      self.selectedCountyCasesIncrease = countyData.map((x, index) => {
        let prevDay = index >= 1 ? index - 1 : 0;
        let prevDayCnt = countyData[prevDay];
        let dayChange = self.percentChangeNum(x, prevDayCnt);
        justPercentNumbers.push(dayChange)
        return self.percentChange(x, prevDayCnt);
      });
      self.selectedCountyIncreaseByDay = countyData.map((x, index) => {
        let prevDay = index >= 1 ? index - 1 : 0;
        let prevDayCnt = countyData[prevDay];
        return  Math.abs(self.diffChange(x, prevDayCnt));
      });
      let last3Days = justPercentNumbers.slice(Math.max(justPercentNumbers.length - 4, 0))
      let average = last3Days.reduce((a, b) => a + b) / last3Days.length;
      self.selectedCountyAvg = average;
      // let countyLatestNum = self.selectedCountyIncreaseByDay[self.selectedCountyIncreaseByDay.length - 1]
      // let plusOne = self.compoundInterest(countyLatestNum, average, 1);
      // let plusTwo = self.compoundInterest(countyLatestNum, average, 2);
      // let plusThree = self.compoundInterest(countyLatestNum, average, 3);
      // projectedData = projectedData.concat(plusOne, plusTwo, plusThree);
      // labels = labels.concat("+1");
      // console.log(projectedData)
      let countyNewPerDay = [...self.selectedCountyIncreaseByDay].splice(self.daysBackToDisplay * -1);
      let avgCases = self.calcAvgCases(self.selectedCountyIncreaseByDay).splice(self.daysBackToDisplay * -1);

      self.lineData = {
          labels: [...labels].splice(self.daysBackToDisplay * -1),
          datasets: [
            {
              label: "7 Day Average",
              // backgroundColor: gradient,
              borderColor: "#008865",
              data: avgCases
            },
            {
              label: "New Positive Cases Per Day",
              backgroundColor: gradient,
              borderColor: "#ea0000",
              data: countyNewPerDay,
              type: 'bar'
            },
          ]
        }
      let countyDeathsData = results.map(x => {
                projectedData.push(null)
                var countyResults = _filter(x.data.features, {
                  attributes: {
                    COUNTYNAME: county.toUpperCase()
                  }
                });
                if(countyResults.length && countyResults[0].attributes){
                  return countyResults[0].attributes.C_FLResDeaths
                    ? parseInt(countyResults[0].attributes.C_FLResDeaths)
                    : 0;
                }else{
                  return 0
                }
              })
      self.selectedCountyIncreaseDeathsByDay = countyDeathsData.map((x, index) => {
        let prevDay = index >= 1 ? index - 1 : 0;
        let prevDayCnt = countyDeathsData[prevDay];
        return self.diffChange(x, prevDayCnt);
      });
      self.barData2 = {
          labels: [...labelsOriginal].splice(self.daysBackToDisplay * -1),
          datasets: [
            // {
            //   label: "Total Deaths",
            //   backgroundColor: gradientBlack,
            //   borderColor: "#929292",
            //   data: countyDeathsData
            // },
            {
              label: "Deaths Reported",
              backgroundColor: "#ce4307",
              borderColor: "#ea0000",
              data: self.selectedCountyIncreaseDeathsByDay.splice(self.daysBackToDisplay * -1),
              type: 'bar'
            }
          ]
        }
      // bottom testing chart
      const labels2 = results.map(x => x.mmdd).splice(self.daysBackToDisplay * -1);
      // prep data
      var activeCases = self.calcActiveCases(self.selectedCountyIncreaseByDay).splice(self.daysBackToDisplay * -1);
      var countyNegative = self.getCountyAttributeValue(results, county, 'T_negative').splice(self.daysBackToDisplay * -1)
      var countyPending = self.getCountyAttributeValue(results, county, 'TPending').splice(self.daysBackToDisplay * -1)
      var countyPositive = self.getCountyAttributeValue(results, county, 'T_positive').splice(self.daysBackToDisplay * -1)
      var countyHospital = self.getCountyAttributeValue(results, county, 'C_HospYes_Res').splice(self.daysBackToDisplay * -1)

      // plot data
      self.lineTestingData = {
          labels: labels2,
          datasets: [
            {
              label: "Active Pos. Cases",
              type: 'line',
              borderColor: "#fb7dd4",
              data: activeCases,
              borderDash: [5,3]
            },
            {
              label: "Pending",
               type: 'bar',
              backgroundColor: "rgba(255, 197, 67, 1)",
              borderColor: "rgba(202, 0, 0, 0)",
              data: countyPending.map((x, index) => {
                  let prevDay = index >= 1 ? index - 1 : 0;
                  let prevDayCnt = countyPending[prevDay];
                  return  Math.abs(self.diffChange(x, prevDayCnt));
                })
            },
            {
              label: "Hospitalized",
               type: 'bar',
              backgroundColor: "yellow",
              borderColor: "rgba(202, 0, 0, 0)",
              data: countyHospital.map((x, index) => {
                  let prevDay = index >= 1 ? index - 1 : 0;
                  let prevDayCnt = countyHospital[prevDay];
                  return  Math.abs(self.diffChange(x, prevDayCnt));
                })
            },
            {
              label: "Positive",
               type: 'bar',
              backgroundColor: "#ea0000",
              borderColor: "rgba(255, 99, 132, 0)",
              data: countyPositive.map((x, index) => {
                  let prevDay = index >= 1 ? index - 1 : 0;
                  let prevDayCnt = countyPositive[prevDay];
                  return  Math.abs(self.diffChange(x, prevDayCnt));
                })
            },
            {
              label: "Negative",
               type: 'bar',
              backgroundColor: "rgba(2, 95, 2, 1)",
              borderColor: "rgba(202, 0, 0, 0)",
              data: countyNegative.map((x, index) => {
                  let prevDay = index >= 1 ? index - 1 : 0;
                  let prevDayCnt = countyNegative[prevDay];
                  return  Math.abs(self.diffChange(x, prevDayCnt));
                })
            },
          ]
        }
    },
    plotDataState: function plotDataState(results) {
      var self = this;
      const resultsSorted = results.sort((a, b) => a.date - b.date)
      let labels = resultsSorted.map(x => x.mmdd);
      let labelsOriginal = [...labels];
      let gradient = document.getElementById("state-chart").getContext("2d").createLinearGradient(0, 0, 0, 450);
      gradient.addColorStop(0, "rgba(255, 0,0, 0.9)");
      gradient.addColorStop(0.5, "rgba(255, 0, 0, 0.65)");
      gradient.addColorStop(1, "rgba(255, 0, 0, 0)");
      let gradientBlack = document.getElementById("county-chart2").getContext("2d").createLinearGradient(0, 0, 0, 450);
      gradientBlack.addColorStop(0, "rgba(0, 0, 0, 0.75)");
      gradientBlack.addColorStop(0.5, "rgba(0, 0, 0, 0.55)");
      gradientBlack.addColorStop(1, "rgba(0, 0, 0, .2)");
      let projectedData = [];
      let justPercentNumbers = [];
      let stateCases = resultsSorted.map(x =>{
        projectedData.push(null)
        return parseInt(x.data.features[0].attributes.Positive)
      });
      let stateDeaths = resultsSorted.map(x =>{
        return parseInt(x.data.features[0].attributes.Deaths)
      });
      this.stateCasesIncrease = stateCases.map((x, index) => {
        let prevDay = index >= 1 ? index - 1 : 0;
        let prevDayCnt = stateCases[prevDay];
        let dayChange = self.percentChangeNum(x, prevDayCnt);
          justPercentNumbers.push(dayChange)
        return self.percentChange(x, stateCases[prevDay]);
      });
      self.selectedStateIncreaseByDay = stateCases.map((x, index) => {
        let prevDay = index >= 1 ? index - 1 : 0;
        let prevDayCnt = stateCases[prevDay];
        return self.diffChange(x, prevDayCnt);
      });
      let last3Days = justPercentNumbers.slice(Math.max(justPercentNumbers.length - 4, 0))
      let average = last3Days.reduce((a, b) => a + b) / last3Days.length;
      self.stateAvg = average;
      let latestValue = stateCases[stateCases.length - 1];
      self.latestDeaths = stateDeaths[stateDeaths.length - 1];
      self.latestStateValue = latestValue;
      // let plusOne = self.compoundInterest(latestValue, average, 1);
      // let plusTwo = self.compoundInterest(latestValue, average, 2);
      // let plusThree = self.compoundInterest(latestValue, average, 3);
      // projectedData = projectedData.concat(plusOne, plusTwo, plusThree);
      // labels = labels.concat("+1");
      // labels = labels.shift();
      let stateNewPerDay = [...self.selectedStateIncreaseByDay].splice(self.daysBackToDisplay * -1);
      let avgCases = self.calcAvgCases(self.selectedStateIncreaseByDay).splice(self.daysBackToDisplay * -1);
      this.stateLineData =  {
          labels: labels.splice(self.daysBackToDisplay * -1),
          datasets: [
{
              label: "7 Day Average",
              // backgroundColor: gradient,
              borderColor: "#008865",
              data: avgCases
            },
            // {
            //   label: "Projected Cases",
            //   borderColor: "#fb7dd4",
            //   data: projectedData,
            //   borderDash: [5,3]
            // },

            {
              label: "New Positive Cases Per Day",
              backgroundColor: gradient,
              borderColor: "#ea0000",
              data: stateNewPerDay,
              type: 'bar'
            },
          ]
        }
      this.selectedStateIncreaseDeathsByDay = stateDeaths.map((x, index) => {
        let prevDay = index >= 1 ? index - 1 : 0;
        let prevDayCnt = stateDeaths[prevDay];
        return self.diffChange(x, prevDayCnt);
      });
      this.stateBarDataDeaths =  {
          labels:[...labelsOriginal].splice(self.daysBackToDisplay * -1),
          datasets: [
            // {
            //   label: "Deaths",
            //   backgroundColor: gradientBlack,
            //   borderColor: "#929292",
            //   data: stateDeaths
            // },
            {
              label: "Deaths Reported",
              backgroundColor: "#ce4307",
              borderColor: "#ea0000",
              data: [...self.selectedStateIncreaseDeathsByDay].splice(self.daysBackToDisplay * -1),
              type: 'bar'
            }
          ]
        }
      const labels2 = resultsSorted.map(x => x.mmdd).splice(self.daysBackToDisplay * -1);



      let statePending = resultsSorted.map(x => x.data.features[0].attributes.Pending).splice(self.daysBackToDisplay * -1)
      let stateNegative = resultsSorted.map(x => x.data.features[0].attributes.Negative).splice(self.daysBackToDisplay * -1)
      let statePositive = resultsSorted.map(x => x.data.features[0].attributes.Positive).splice(self.daysBackToDisplay * -1)
      let stateHospitalized = resultsSorted.map(x => x.data.features[0].attributes.Hospitalized).splice(self.daysBackToDisplay * -1)

      var activeStateCases = self.calcActiveCases(self.selectedStateIncreaseByDay).splice(self.daysBackToDisplay * -1);
          this.stateLineTestingData = {
          labels: labels2,
          datasets: [
            {
              label: "Active Pos. Cases",
              type: 'line',
              borderColor: "#fb7dd4",
              data: activeStateCases,
              borderDash: [5,3]
            },
            {
              label: "Pending",
              type: 'bar',
              backgroundColor: "rgba(255, 197, 67, 1)",
              borderColor: "rgba(202, 0, 0, 0)",
              data: statePending.map((x, index) => {
                  let prevDay = index >= 1 ? index - 1 : 0;
                  let prevDayCnt = statePending[prevDay];
                  return  Math.abs(self.diffChange(x, prevDayCnt));
                })
            },
            {
              label: "Hospitalized",
              type: 'bar',
              backgroundColor: "yellow",
              borderColor: "rgba(202, 0, 0, 0)",
              data: stateHospitalized.map((x, index) => {
                  let prevDay = index >= 1 ? index - 1 : 0;
                  let prevDayCnt = stateHospitalized[prevDay];
                  return  Math.abs(self.diffChange(x, prevDayCnt));
                })
            },{
              label: "Positive",
              type: 'bar',
              backgroundColor: "#ea0000",
              borderColor: "rgba(202, 0, 0, 0)",
              data: statePositive.map((x, index) => {
                  let prevDay = index >= 1 ? index - 1 : 0;
                  let prevDayCnt = statePositive[prevDay];
                  return  Math.abs(self.diffChange(x, prevDayCnt));
                })
            },{
              label: "Negative",
              type: 'bar',
              backgroundColor: "rgba(2, 95, 2, 1)",
              borderColor: "rgba(202, 0, 0, 0)",
              data: stateNegative.map((x, index) => {
                  let prevDay = index >= 1 ? index - 1 : 0;
                  let prevDayCnt = stateNegative[prevDay];
                  return  Math.abs(self.diffChange(x, prevDayCnt));
                })
            },


            // {
            //   label: "Deaths",
            //   backgroundColor: "black",
            //   borderColor: "rgba(202, 0, 0, 0)",
            //   data: resultsSorted.map(x => x.data.features[0].attributes.Deaths)
            // }
          ]
        }
    },
    percentChange: function percentChange(val1 = 0, val2) {
      let percent = ((val1 - val2) / val1 ) * 100
      if(percent > 0){
        return `<span class="text-danger">+${(percent).toFixed(0)}%</span>`;
      }else if(percent == 0){
        return `${(percent).toFixed(0)}%`;
      }else{
        return `<span class="text-success">-${(percent).toFixed(0)}%</span>`;
      }
    },
    percentChangeNum: function percentChangeNum(val1 = 0, val2) {
      return  parseInt((((val1 - val2) / val1 ) * 100).toFixed(0));
    },
    diffChange: function diffChange(val1, val2) {
      return  (val1 - val2).toFixed(0);
    },
    compoundInterest(present_val,interest,times){
      var x=(1+interest/100)
      var future_val=present_val*(Math.pow(x,times))
      return parseInt(future_val.toFixed(0));
    },
    getCountyAttributeValue(results, county, attributeName){
      return results.map(x => {
        var countyResults = _filter(x.data.features, {
          attributes: {
            COUNTYNAME: county.toUpperCase()
          }
        });
        if(countyResults.length && countyResults[0].attributes){
        return countyResults[0].attributes[attributeName]
          ? countyResults[0].attributes[attributeName]
          : 0;
        }else{
          return 0
        }
      })
    },
    calcActiveCases(listData){
      return listData.map((x, index) => {
        let start = 0;
        if(index >= this.daysForActiveCases){
          start = index - (this.daysForActiveCases)
        }
        let activeRange = listData.slice(start, index)
        return activeRange.reduce((a,b) => parseInt(a) + parseInt(b), 0)
      });
    },
    calcAvgCases(listData){
      let daysBack = 7;
      return listData.map((x, index) => {
        let start = 0;
        if(index >= daysBack){
          start = index - (daysBack + 1)
        }
        let activeRange = listData.slice(start, index)
        return activeRange.reduce((a,b) => parseInt(a) + parseInt(b), 0) / daysBack
      });
    }

  },
  metaInfo() {
    return {
      meta: [
          // Twitter Card
          {name: 'twitter:card', content: 'summary'},
          {name: 'twitter:title', content: 'Florida COVID-19 Tracker'},
          {name: 'twitter:description', content: 'Track the spread in your florida county.'},
          // image must be an absolute path
          {name: 'twitter:image', content: this.logo},
          // Facebook OpenGraph
          {property: 'og:title', content: 'Florida COVID-19 Tracker'},
          {property: 'og:site_name', content: 'flacoronavirustracker.com'},
          {property: 'og:type', content: 'website'},
          {property: 'og:image', content:  this.logo},
          {property: 'og:description', content: 'Track the spread in your florida county.'}
      ]
    }
  }
};
</script>

<style>
@media only screen and (min-width: 768px){
.text-right-desktop {
    text-align: right;
}
}
.ranking {
  height: 32px;
  min-width: 1%;
  display: inline-block;
}

.count {
  min-width: 68px;
  padding-right: 5px;
  display: inline-block;
  font-weight: bold;
  text-align: right;
  font-size: 18px;
}

.rank-list {
  max-height: 40vh;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 1rem 0.66rem;
  margin-bottom: 1rem;
}
.state-col{
  margin-top: 2rem;
}
@media only screen and (min-width: 768px){
  .rank-list {
    max-height: 415px;
  }
  .state-col{
    margin-top: 0;
  }
}

.rank-list .item {
  padding: 5px 0;
  display: flex;
}
.col-name {width: 33%; overflow:hidden; text-overflow: ellipsis;}
.col-cnt {flex-grow: 1; padding: 0 5px;}
.col-capital {width: 60px;}

.rank-list .item:nth-child(1) .teamname {
  font-size: 150%;
  font-weight: 700;
}

.rank-list .item:nth-child(2) .teamname {
  font-size: 120%;
  font-weight: 600;
}

.active {
  outline: solid 3px #fb7dd4 !important;
}

.item:hover {
  cursor: pointer;
  outline: solid 3px #fb7dd44f;
}

.percentChange{
  display: flex;
  justify-content: space-between;
  font-size: 12px;
}
@media only screen and (min-width: 768px){
  .percentChange{
  padding: 0 77px  0 2rem;
}
}
.fa-2x,
.fa-3x{
  line-height: 1;
}
.fa-1x{
  font-size: 1rem;
}
/* .trend-label::before {
  content: "....";
  color: blue;
  padding-right: 1.5rem;
  font-size: 2rem;
  display: inline-block;
  transform: rotate(-33deg) translate(14px, 1px);
}

.trend-label {
  font-size: 12px;
} */
.list-group .row{
  line-height: 1.45;
  display: flex;
  align-items: center;
}
.list-group{
  margin-bottom: 0;
}
.text-danger{
  color: #E74C3C ;
}
        .padded {
            padding: 0.75rem 0.55rem;
        }

        .text-primary {
            color: #ce0a07;
        }

        .background-primary {
            background-color: #ce0a07;
            color: white;
        }

        .background-secondary {
            background-color: #008865 !important;
            color: white;
        }

        .badge {
            display: inline-block;
            min-width: 10px;
            padding: 3px 7px;
            /* font-size: 16px; */
            font-weight: 700;
            color: #fff;
            line-height: 1;
            vertical-align: middle;
            white-space: nowrap;
            text-align: center;
            background-color: #ce0a07;
            border-radius: 5px;
        }

        .flex {
            display: flex;
        }

        .solid-bk {
            background-color: #303030;
            padding: 1rem;
            /* border-radius: 5px; */
        }

        .text-white {
            color: white;
            text-shadow: 0px 0px 7px black;
        }

        h1 {
            font-size: 2rem !important;
            background-color: #303030;
            display: inline-block;
            padding: 5px 7px !important;
        }

        hr {
            border-top: 1px solid rgba(253, 253, 253, 0.42);
        }
        .refresh-modal{
          display: block !important;
        }
        .refresh-modal .modal-content{
          width: 100vw;
          height: 100vh;
          display: flex;
          justify-content: center;
          align-items: center;
          text-align: center;
          background-color: #303030eb;
        }
</style>
